<%- include('partials/header') %>

<section class="record-detail" style="max-width:800px;margin:30px auto;padding:20px;background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.05);">
  <h2 style="color:var(--accent);margin-bottom:10px;">Report — <%= record.date %></h2>
  <ul style="list-style:none;padding:0;margin:0;">
    <% Object.keys(record.totals).forEach(name => { %>
      <li style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
        <strong><%= name %></strong>
        <span><%= record.totals[name] %></span>
      </li>
    <% }) %>
  </ul>

  <form method="post" action="/generate-report" style="margin-top:20px;">
    <input type="hidden" name="date" value="<%= record.date %>">
    <select name="type" style="padding:8px;border-radius:8px;margin-right:8px;">
      <option value="pdf">PDF</option>
      <option value="txt">Text</option>
    </select>
    <button class="btn-cta" type="submit">Download</button>
  </form>

  <a href="/records" class="btn" style="margin-top:16px;display:inline-block;">Back to Reports</a>
  
  <!-- Replace the form with a button that uses fetch -->
  <button 
    class="btn" 
    onclick="deleteRecord('<%= record._id %>', '<%= record.date %>')"
    style="background:#fff0f0;border:1px solid #cc0000;color:#cc0000;border-radius:8px;padding:8px 14px;font-weight:600;margin-top:20px;cursor:pointer;">
    Delete This Report
  </button>
</section>

<script>
async function deleteRecord(id, date) {
  if (!confirm(`Are you sure you want to delete the report for ${date}?`)) return;

  try {
    const res = await fetch(`/record/${id}`, {
      method: 'DELETE',
      credentials: 'include', // ✅ needed for session-based auth
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });

    if (!res.ok) {
      const text = await res.text();
      console.error('Server response:', text);
      alert('⚠️ Server error while deleting record.');
      return;
    }

    const data = await res.json();
    if (data.success) {
      // Redirect back to records page after successful deletion
      window.location.href = '/records';
    } else {
      alert('⚠️ ' + (data.message || 'Error deleting record.'));
    }
  } catch (err) {
    console.error('Fetch error:', err);
    alert('Something went wrong.');
  }
}
</script>

<%- include('partials/footer') %>